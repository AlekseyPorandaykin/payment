#Проект платёжной системы

##Бизнес логика:
В системе существуют клиенты, у которых есть счета(кошельки) с денежными средствами в определённой валюте. 
Они могут переводить денежные средства между собой. Все операции связанные со счётом фиксируются в истории. 
Если перевод состоялся, но запись не сохранилась в историю, то такая операция считается ошибочной и откатывается.

###Термины в системе:
- Клиент - пользователь системы, у которого есть счёт(кошелёк) в системе. Для пользователя должно быть указано имя, город и страна регистрации. 
В одном городе и стране может быть только один клиент с уникальным именем.

- Счёт(Кошелёк) - счёт клиента, в котором храниться денежные средства в валюте, указанной при регистрации. У клиента может быть только один кошелёк.

- Валюта - денежные средства в которой можно вести операции в системе. В системе основной валютой является USD. Для заведения валюты необходимо указать его полное название и 
трёхбуквенный алфавитный код.

- Курс валюты - стоимость валюты по отношению к USD (за сколько USD можно купить данную валюту).

- Отчёт - список всех операций на счёте клиента.



##Установка:
Код проекта располагается в папке /app
Для локальной разработки настроен окружение через docker. Если планируется использовать проект не локально, 
то необходимо настроить файл /app/.env самостоятельно
Добавьте в /etc/hosts  запись "127.0.1.1	dev.local" или используйте localhost как host системы

Для запуска проекта запустите команду `make up`

При первоначальном запуске выполните инициализацию проекта `make init` 

##Апи
Предполагается, что апи будут пользоваться внутри компании, поэтому для некоторых операции не вводятся проверки безопасности.
Описание всех роутов находиться в app/config/routes.yaml.

1) Регистрация клиента с указанием его имени, страны, города регистрации, валюте создаваемого кошелька

    curl --location --request POST 'dev.local/api/registration' \
    --header 'Content-Type: application/json' \
    --data-raw '{"name":"Имя пользователя", "country":"Страна", "city":"Город", "currency_code": "Код валюты"}'
    
2) Зачисление денежных средств на кошелёк клиента

    curl --location --request POST 'dev.local/api/money/deposit' \
    --header 'Content-Type: text/plain' \
    --data-raw '{"user_guid":"Guid клиента", "amount":"Сумма"}'
 
3) Перевод денежных средств с одного кошелька на другой.

    curl --location --request POST 'dev.local/api/money/transfer' \
    --header 'Content-Type: application/json' \
    --data-raw '{"client_from":"Guid клиента отправителя", "client_to":"Guid клиента получателя", "currency_code":"Код валюты", "amount": "Сумма"}'
    
4) Загрузка котировки валюты к USD на дату

    curl --location --request POST 'dev.local/api/exchange/load' \
    --header 'Content-Type: text/plain' \
    --data-raw '{"currency_code":"Код валюты","rate":"Ставка", "date":"Дата"}'
    
5) Добавить новую валюту
    
    curl --location --request POST 'dev.local/api/currency/create' \
    --header 'Content-Type: application/json' \
    --data-raw '{"name":"Название валюты", "code":"Код валюты"}'
    
##Описание приложения
Основная страница отчёта http://dev.local/
Для просмотра отчёта необходимо указать guid клиента (обязательно) и период отчётности (необязательно)

После запроса формируется общая информация и таблица записей.
В общей информации указано кол-во найденых записей, ссылки на отчёты в виде csv и xml файлам, общую сумму операций по счету за период в USD и валюте счета

#Техническая сторона
Все данные сохраняются в бд Mysql. При запросе в таблице > 1млн. записей поиск происходит быстро.
При формировании отчёта, если данных > 1500 000 записей, то локально могут быть проблемы с обработкой и сохранением большого кол-ва данных. 
Решением является увеличение мощностей. Если несколько раз запрашивать один и тот же отчёт, то по времени больше формировать будет только в первый раз. 
В остальных случаях данные будут браться из сохранённого файла csv (используется в виде кеша) и отдаваться будут быстрее. 
Если запрашивать отчёт у нового клиента раз в несколько секунд, то возможны отставания от реальных данных, т.к. данные кешируются и минимально хранятся минуту.
Минусом данного решения является то , что скорость зависит от мощностей сервера.

Для улучшения производительности стоит рассмотреть систему для хранения логов Clickhouse или Elasticsearch, т.к. поиск и выдача данных будет быстрее.

Стоит рассмотреть вынесения функционала создания отчёта в отдельный сервис с выделенными ресурсами. Формировать нужные отчёты в соответствующих форматах, 
хранение их некоторые время.

